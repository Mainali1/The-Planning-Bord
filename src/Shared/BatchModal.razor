@using ThePlanningBord.Models
@using ThePlanningBord.Services
@inject IInventoryService InventoryService
@inject NotificationService NotificationService

@if (Show)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto" aria-labelledby="modal-title-batch" role="dialog" aria-modal="true">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true" @onclick="Close">
            <div class="absolute inset-0 bg-gray-500/75 dark:bg-gray-900/80"></div>
        </div>
        <div class="relative w-full max-w-4xl bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700 transform transition-all">
            <div class="bg-white dark:bg-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title-batch">Batch Management</h3>
            </div>
            <div class="p-6">
                @if (isLoading)
                {
                    <div class="flex justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-gray-500 dark:text-gray-400">Loading batches...</span>
                    </div>
                }
                else
                {
                    <!-- Add New Batch -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">@(editingBatch.Id.HasValue ? "Edit Batch" : "Add New Batch")</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Batch #</label>
                                <input type="text" @bind="editingBatch.BatchNumber" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Quantity</label>
                                <input type="number" @bind="editingBatch.Quantity" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                <select @bind="editingBatch.Status" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="active">Active</option>
                                    <option value="expired">Expired</option>
                                    <option value="depleted">Depleted</option>
                                    <option value="quarantine">Quarantine</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Mfg Date</label>
                                <input type="date" @bind="mfgDate" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Exp Date</label>
                                <input type="date" @bind="expDate" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Supplier</label>
                                <select @bind="editingBatch.SupplierId" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="">-- Select Supplier --</option>
                                    @foreach (var s in suppliers)
                                    {
                                        <option value="@s.Id">@s.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Supplier Info (Legacy)</label>
                                <input type="text" @bind="editingBatch.SupplierInfo" class="block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-3">
                            @if(editingBatch.Id.HasValue) 
                            {
                                <button @onclick="CancelEdit" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                            }
                            <button @onclick="SaveBatch" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors">
                                @(editingBatch.Id.HasValue ? "Update" : "Add")
                            </button>
                        </div>
                    </div>

                    <!-- Existing Batches List -->
                    <div class="overflow-hidden border border-gray-200 dark:border-gray-700 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-900/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Batch #</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Supplier</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Qty</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Exp Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                @if (!batches.Any())
                                {
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400">No batches found.</td></tr>
                                }
                                @foreach (var b in batches)
                                {
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">@b.BatchNumber</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                            @(suppliers.FirstOrDefault(s => s.Id == b.SupplierId)?.Name ?? "-")
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@b.Quantity</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@b.ExpirationDate</td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full @GetStatusClass(b.Status)">
                                                @b.Status
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button @onclick="() => EditBatch(b)" class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 transition-colors">Edit</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex flex-row-reverse">
                <button type="button" @onclick="Close" class="inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }
    [Parameter] public int ProductId { get; set; }

    private bool isLoading = false;
    private List<InventoryBatch> batches = new();
    private List<Supplier> suppliers = new();
    private InventoryBatch editingBatch = new();
    private DateTime? mfgDate;
    private DateTime? expDate;

    protected override async Task OnParametersSetAsync()
    {
        if (Show && ProductId > 0)
        {
            await LoadBatches();
            await LoadSuppliers();
            ResetForm();
        }
    }

    private async Task LoadBatches()
    {
        isLoading = true;
        try
        {
            batches = await InventoryService.GetBatchesAsync(ProductId);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load batches: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSuppliers()
    {
        try
        {
            suppliers = await InventoryService.GetSuppliersAsync();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load suppliers: " + ex.Message);
        }
    }

    private void ResetForm()
    {
        editingBatch = new InventoryBatch { ProductId = ProductId, Status = "active" };
        mfgDate = DateTime.Now;
        expDate = null;
    }

    private void EditBatch(InventoryBatch b)
    {
        editingBatch = new InventoryBatch 
        { 
            Id = b.Id, 
            ProductId = b.ProductId, 
            BatchNumber = b.BatchNumber, 
            Quantity = b.Quantity, 
            ManufacturingDate = b.ManufacturingDate, 
            ExpirationDate = b.ExpirationDate, 
            SupplierInfo = b.SupplierInfo, 
            SupplierId = b.SupplierId,
            Status = b.Status, 
            Notes = b.Notes 
        };
        
        if (DateTime.TryParse(b.ManufacturingDate, out var mfg)) mfgDate = mfg; else mfgDate = null;
        if (DateTime.TryParse(b.ExpirationDate, out var exp)) expDate = exp; else expDate = null;
    }

    private void CancelEdit()
    {
        ResetForm();
    }

    private async Task SaveBatch()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(editingBatch.BatchNumber))
            {
                NotificationService.ShowError("Batch Number is required.");
                return;
            }

            editingBatch.ManufacturingDate = mfgDate?.ToString("yyyy-MM-dd");
            editingBatch.ExpirationDate = expDate?.ToString("yyyy-MM-dd");

            if (editingBatch.Id.HasValue)
            {
                await InventoryService.UpdateBatchAsync(editingBatch);
                NotificationService.ShowSuccess("Batch updated.");
            }
            else
            {
                editingBatch.ProductId = ProductId;
                await InventoryService.AddBatchAsync(editingBatch);
                NotificationService.ShowSuccess("Batch added.");
            }
            await LoadBatches();
            ResetForm();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to save batch: " + ex.Message);
        }
    }

    private async Task Close()
    {
        Show = false;
        await ShowChanged.InvokeAsync(false);
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "active" => "bg-green-100 text-green-800",
            "expired" => "bg-red-100 text-red-800",
            "depleted" => "bg-gray-100 text-gray-800",
            "quarantine" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
}
