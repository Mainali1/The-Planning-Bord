@inherits LayoutComponentBase
@inject BackgroundJobService BackgroundService
@inject ISystemService SystemService
@inject IUserService UserService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@using ThePlanningBord.Auth

    <div class="flex h-screen bg-gray-100 font-sans overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 flex-shrink-0">
            <NavMenu />
        </div>

        <div class="flex-1 flex flex-col overflow-hidden min-w-0">
            <header class="bg-white shadow-sm z-10">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <div class="flex items-center">
                        <button @onclick="ToggleSidebar" class="mr-4 text-gray-500 focus:outline-none md:hidden">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold leading-tight text-gray-900 truncate">
                            @companyName
                        </h1>
                    </div>
                <div class="flex items-center space-x-4">
                    <button @onclick="OpenHelp" class="text-gray-400 hover:text-gray-500 focus:outline-none" title="Help">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <span class="text-sm text-gray-500">License: Active</span>
                    <button @onclick="Logout" class="text-sm text-red-600 hover:text-red-800 font-medium border border-red-200 rounded px-3 py-1 hover:bg-red-50">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
            <div class="container mx-auto px-6 py-8">
                <ErrorBoundary>
                    @Body
                </ErrorBoundary>
            </div>
        </main>
    </div>
    
</div>
<ToastContainer />
<OnboardingTour />
<HelpModal @ref="helpModal" />

@code {
    private HelpModal? helpModal;
    private bool sidebarOpen = false;
    private string companyName = "The Planning Bordâ„¢";

    protected override async Task OnInitializedAsync()
    {
        // Avoid running setup check if we are already on the setup page
        var uri = Navigation.Uri;
        if (uri.Contains("/setup"))
        {
            return;
        }

        try
        {
            var isSetup = await SystemService.GetSetupStatusAsync();
            if (!isSetup)
            {
                Navigation.NavigateTo("/setup", true);
                return;
            }

            var name = await SystemService.GetCompanyNameAsync();
            if (!string.IsNullOrWhiteSpace(name))
            {
                companyName = name;
            }

            // Update client info for audit logs
            try
            {
                var ua = await JS.InvokeAsync<string>("getUserAgent");
                await SystemService.UpdateClientInfoAsync("127.0.0.1", ua);
            }
            catch (Exception ex)
            {
                 Console.WriteLine($"Client info update failed: {ex.Message}");
            }

            // Auth check is now handled by App.razor and AuthorizeRouteView
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Setup check failed: {ex.Message}");
        }

        BackgroundService.Start();
    }

    private async Task Logout()
    {
        await UserService.LogoutAsync();
        if (AuthStateProvider is CustomAuthenticationStateProvider customAuth)
        {
            customAuth.NotifyUserLogout();
        }
        Navigation.NavigateTo("/login");
    }

    private void OpenHelp()
    {
        helpModal?.Open();
    }

    private void ToggleSidebar()
    {
        sidebarOpen = !sidebarOpen;
    }
}
