@page "/settings"
@attribute [Authorize]
@inject ISystemService SystemService
@inject IJSRuntime JS
@inject MicrosoftGraphService GraphService
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService
@inject IThemeService ThemeService
@inject SmtpEmailService SmtpService
@using ThePlanningBord.Services
@using ThePlanningBord.Auth

<PageTitle>Settings - The Planning Bord</PageTitle>

<div class="flex h-full bg-gray-50 dark:bg-gray-900">
    <!-- Sidebar -->
    <div class="w-64 bg-white dark:bg-gray-800 shadow-md flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white">Settings</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Manage application preferences</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <button @onclick='() => ChangeTab("general")' class="@GetTabClass("general") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                General
            </button>
            <button @onclick='() => ChangeTab("access")' class="@GetTabClass("access") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Access Control
            </button>
            <button @onclick='() => ChangeTab("features")' class="@GetTabClass("features") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Features
            </button>
            <button @onclick='() => ChangeTab("integrations")' class="@GetTabClass("integrations") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Integrations
            </button>
            <button @onclick='() => ChangeTab("audit")' class="@GetTabClass("audit") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Audit Logs
            </button>
            <button @onclick='() => ChangeTab("maintenance")' class="@GetTabClass("maintenance") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Maintenance
            </button>
        </nav>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-8">
        @if (activeTab == "general")
        {
            <div class="max-w-4xl space-y-6">
                <!-- Inventory Settings -->
                <section class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-medium text-gray-900 dark:text-white">Inventory Configuration</h3>
                         <p class="text-sm text-gray-500 dark:text-gray-400">Manage global inventory and purchasing settings.</p>
                    </div>
                    <div class="p-6">
                        <div class="max-w-md">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Global Order Email</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="email" @bind="globalOrderEmail" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white sm:text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="fallback@example.com">
                                <button type="button" @onclick="SaveGlobalOrderEmail" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Save
                                </button>
                            </div>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">This email will be used for auto-orders if the supplier does not have a specific Order Email defined.</p>
                        </div>
                    </div>
                </section>

                <!-- Email Configuration (SMTP) -->
                <section class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-medium text-gray-900 dark:text-white">Email Configuration (SMTP)</h3>
                         <p class="text-sm text-gray-500 dark:text-gray-400">Configure outbound email settings (Gmail, Outlook, etc.).</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">SMTP Host</label>
                                <input type="text" @bind="smtpConfig.Host" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="smtp.gmail.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Port</label>
                                <input type="number" @bind="smtpConfig.Port" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="587">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                                <input type="text" @bind="smtpConfig.Username" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="your_email@gmail.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password / App Password</label>
                                <input type="password" @bind="smtpConfig.Password" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="App Password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">From Email</label>
                                <input type="email" @bind="smtpConfig.FromEmail" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="your_email@gmail.com">
                            </div>
                            <div class="flex items-center pt-6">
                                <input id="use_ssl" type="checkbox" @bind="smtpConfig.UseSsl" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                                <label for="use_ssl" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Use SSL (Implicit, port 465)</label>
                            </div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="button" @onclick="SaveSmtpConfig" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Save SMTP Settings
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Note: For Gmail, use "smtp.gmail.com", port 587 (STARTTLS) or 465 (SSL). Enable "App Passwords" in your Google Account Security settings if 2FA is on.
                        </p>
                    </div>
                </section>

                <!-- Appearance -->
                <section class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-medium text-gray-900 dark:text-white">Appearance</h3>
                         <p class="text-sm text-gray-500 dark:text-gray-400">Customize the look and feel of the application.</p>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">Theme Preference</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Choose your preferred theme.</p>
                        </div>
                        <div class="flex items-center space-x-6">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" class="form-radio text-blue-600 focus:ring-blue-500 h-4 w-4" name="theme" 
                                       checked="@(themePreference == "light")" 
                                       @onchange="@(() => SetTheme("light"))">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Light</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" class="form-radio text-blue-600 focus:ring-blue-500 h-4 w-4" name="theme" 
                                       checked="@(themePreference == "dark")" 
                                       @onchange="@(() => SetTheme("dark"))">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Dark</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" class="form-radio text-blue-600 focus:ring-blue-500 h-4 w-4" name="theme" 
                                       checked="@(themePreference == "system")" 
                                       @onchange="@(() => SetTheme("system"))">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">System</span>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Notifications -->
                <section class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-medium text-gray-900 dark:text-white">Notifications</h3>
                         <p class="text-sm text-gray-500 dark:text-gray-400">Manage how you receive alerts and updates.</p>
                    </div>
                    <div class="p-6 flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">Push Notifications</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Get notified when stock is low or tasks are due.</p>
                        </div>
                        <div class="flex items-center">
                            <button type="button" @onclick="ToggleNotifications" class="@(notificationsEnabled ? "bg-blue-600" : "bg-gray-200 dark:bg-gray-700") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <span class="@(notificationsEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Integrations Link -->
                <section class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                         <h3 class="text-lg font-medium text-gray-900 dark:text-white">Integrations</h3>
                         <p class="text-sm text-gray-500 dark:text-gray-400">Connect external tools and services.</p>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white">Manage Integrations</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Connect with QuickBooks, Salesforce, Slack, and more.</p>
                            </div>
                            <button @onclick='() => Navigation.NavigateTo("/integrations")' class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Configure Integrations
                            </button>
                        </div>
                    </div>
                </section>

                <div class="flex justify-end pt-4">
                    <button type="button" @onclick="SaveGeneralSettings" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        }
        else if (activeTab == "access")
        {
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 h-full flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Roles List -->
                    <div class="col-span-1 border-r border-gray-200 dark:border-gray-700 pr-4 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Roles</h4>
                            <button @onclick="OpenAddRoleModal" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 font-medium">+ Add Role</button>
                        </div>
                        <ul class="divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto flex-1">
                            @if (roles != null)
                            {
                                @foreach (var role in roles)
                                {
                                    <li class="py-3 px-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer @(selectedRole?.Id == role.Id ? "bg-blue-50 dark:bg-blue-900/30" : "")" @onclick="() => SelectRole(role)">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="text-sm font-medium text-gray-900 dark:text-white">@role.Name</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">@role.Description</p>
                                            </div>
                                            @if (role.IsCustom)
                                            {
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400">Custom</span>
                                            }
                                        </div>
                                    </li>
                                }
                            }
                        </ul>
                    </div>
                    
                    <!-- Permissions -->
                    <div class="col-span-2 flex flex-col h-full overflow-hidden">
                        @if (selectedRole != null)
                        {
                            <div class="mb-4 flex-shrink-0">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Permissions: @selectedRole.Name</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Configure access rights for this role.</p>
                            </div>
                            <div class="flex-1 overflow-y-auto pr-2">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    @if (permissions != null)
                                    {
                                        @foreach (var perm in permissions)
                                        {
                                            <div class="relative flex items-start p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <div class="flex items-center h-5">
                                                    <input id="perm-@perm.Id" type="checkbox" checked="@(rolePermissionIds.Contains(perm.Id))" @onchange="@(e => TogglePermission(perm.Id, e.Value))" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded" />
                                                </div>
                                                <div class="ml-3 text-sm">
                                                    <label for="perm-@perm.Id" class="font-medium text-gray-700 dark:text-gray-300 cursor-pointer">@perm.Code</label>
                                                    <p class="text-gray-500 dark:text-gray-400 text-xs">@perm.Description</p>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end flex-shrink-0">
                                <button @onclick="SaveRolePermissions" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Save Permissions</button>
                            </div>
                        }
                        else
                        {
                            <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                                <div class="text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No role selected</h3>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select a role from the list to view and edit permissions.</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "features")
        {
            <div class="max-w-4xl space-y-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Feature Management</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Enable or disable system modules and experimental features.</p>
                </div>
                @if (featureToggles != null)
                {
                    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md">
                        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                            @foreach (var toggle in featureToggles)
                            {
                                <li class="px-6 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-gray-900 dark:text-white">@toggle.Key</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">Controls visibility of the @toggle.Key module</span>
                                    </div>
                                    <button type="button" @onclick="() => ToggleFeature(toggle)" class="@(toggle.IsEnabled ? "bg-green-500" : "bg-gray-200 dark:bg-gray-700") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span aria-hidden="true" class="@(toggle.IsEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
        else if (activeTab == "audit")
        {
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden flex flex-col h-full">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">System Audit Logs</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Track all changes and access events.</p>
                    </div>
                    <button @onclick="ExportLogs" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Export to CSV
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 flex flex-wrap gap-4 items-end flex-shrink-0">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">User ID</label>
                        <input type="number" @bind="auditUserId" class="mt-1 block w-32 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm placeholder" placeholder="ID">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Action</label>
                        <input type="text" @bind="auditAction" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm placeholder" placeholder="Action">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <input type="text" @bind="auditCategory" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm placeholder" placeholder="Category">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">From</label>
                        <input type="date" @bind="auditDateFrom" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">To</label>
                        <input type="date" @bind="auditDateTo" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <button @onclick="FilterLogs" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Filter
                        </button>
                    </div>
                </div>

                <div class="overflow-auto flex-1">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-900 sticky top-0">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">User</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Entity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Details</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Client Info</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            @if (auditLogs != null)
                            {
                                @foreach (var log in auditLogs)
                                {
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@log.CreatedAt</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">@(log.UserName ?? $"User {log.UserId}")</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400">
                                                @log.Action
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@log.Category</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@log.Entity (@log.EntityId)</td>
                                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs" title="@log.Details">@log.Details</td>
                                        <td class="px-6 py-4 text-xs text-gray-500 dark:text-gray-400">
                                            <div>@log.IpAddress</div>
                                            <div class="truncate max-w-xs" title="@log.UserAgent">@log.UserAgent</div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Loading logs...</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
                    <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50" @onclick="PrevPage" disabled="@(auditPage == 1)">Previous</button>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Page @auditPage</span>
                    <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
        else if (activeTab == "maintenance")
        {
             <div class="max-w-4xl space-y-6">
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">System Configuration</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Advanced settings and maintenance tools.</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 p-4 rounded">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700 dark:text-yellow-400 font-medium">
                                        Warning
                                    </p>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                                        Advanced system operations should only be performed by Technical Support or Administrators. Improper changes may affect system stability.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Setup & Maintenance</h5>
                            <div class="flex space-x-4">
                                <button @onclick="RunSetupWizard" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 dark:text-indigo-400 bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Run Setup Wizard
                                </button>
                                <button @onclick="SeedDemoDataAsync" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-green-700 dark:text-green-400 bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-900/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Generate Demo Data
                                </button>
                            </div>
                            <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <h5 class="text-sm font-medium text-red-700 dark:text-red-400 mb-2">Danger Zone</h5>
                                <button @onclick="ResetDatabaseAsync" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-red-700 dark:text-red-400 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    Reset Database (Wipes All Data)
                                </button>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">This will permanently delete all data (including audit logs) and re-initialize the database. Only use if you need to start fresh.</p>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        }
    </div>
</div>

@if (showAddRoleModal)
{
    <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title-add-role" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div @onclick="() => showAddRoleModal = false" class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-200 dark:border-gray-700">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/30 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title-add-role">Add New Role</h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label for="roleName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Role Name</label>
                                    <input type="text" id="roleName" @bind="newRoleName" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Warehouse Manager">
                                </div>
                                <div>
                                    <label for="roleDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                                    <textarea id="roleDescription" @bind="newRoleDescription" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Briefly describe the role's purpose."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200 dark:border-gray-700">
                    <button type="button" @onclick="SaveNewRole" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors">Save Role</button>
                    <button type="button" @onclick="() => showAddRoleModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "general";
    private bool notificationsEnabled;
    private bool emailAlertsEnabled = false;
    private string adminEmail = "";
    private string globalOrderEmail = "";
    private SmtpConfig smtpConfig = new();
    private string themePreference = "system";
    private bool isM365Connected;
    
    // Access Control
    private List<Role>? roles;
    private List<Permission>? permissions;
    private Role? selectedRole;
    private HashSet<int> rolePermissionIds = new HashSet<int>();
    private bool showAddRoleModal = false;
    private string newRoleName = "";
    private string newRoleDescription = "";

    // Features
    private List<FeatureToggle>? featureToggles;

    // Audit
    private List<AuditLog>? auditLogs;
    private int auditPage = 1;
    private int? auditUserId;
    private string? auditAction;
    private string? auditCategory;
    private DateTime? auditDateFrom;
    private DateTime? auditDateTo;

    protected override async Task OnInitializedAsync()
    {
        var enabledStr = await JS.InvokeAsync<string>("getSetting", "notifications_enabled");
        bool.TryParse(enabledStr, out notificationsEnabled);

        var emailStr = await JS.InvokeAsync<string>("getSetting", "email_alerts_enabled");
        if (!string.IsNullOrEmpty(emailStr)) bool.TryParse(emailStr, out emailAlertsEnabled);

        adminEmail = await JS.InvokeAsync<string>("getSetting", "admin_email") ?? "";
        globalOrderEmail = await JS.InvokeAsync<string>("getSetting", "global_order_email") ?? "";
        
        await LoadSmtpConfig();

        themePreference = await ThemeService.GetThemePreferenceAsync();
        
        isM365Connected = await GraphService.IsConnected();

        await LoadRoles();
        await LoadPermissions();
        await LoadFeatureToggles();
        await UpdateClientInfo();
        await LoadAuditLogs();
    }
    
    private async Task UpdateClientInfo()
    {
        try
        {
            var ua = await JS.InvokeAsync<string>("getUserAgent");
            // In a real web app we might use an IP service, but for this desktop app we'll just use a placeholder or local
            await SystemService.UpdateClientInfoAsync("127.0.0.1", ua);
        }
        catch (Exception ex) { NotificationService.ShowWarning("Failed to update client info: " + ex.Message); }
    }

    private string GetTabClass(string tab)
    {
        return activeTab == tab 
            ? "bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border-r-4 border-blue-600" 
            : "text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white";
    }

    private void ChangeTab(string tab)
    {
        activeTab = tab;
    }

    // General
    private async Task SaveGeneralSettings()
    {
        await JS.InvokeVoidAsync("setSetting", "notifications_enabled", notificationsEnabled.ToString());
        NotificationService.ShowSuccess("Settings saved successfully!");
    }

    private async Task SaveGlobalOrderEmail()
    {
        await JS.InvokeVoidAsync("saveSetting", "global_order_email", globalOrderEmail);
        NotificationService.ShowSuccess("Global Order Email saved successfully.");
    }

    private async Task LoadSmtpConfig()
    {
        var config = await SmtpService.GetConfigAsync();
        if (config != null) smtpConfig = config;
    }

    private async Task SaveSmtpConfig()
    {
        await SmtpService.SaveConfigAsync(smtpConfig);
        NotificationService.ShowSuccess("SMTP Configuration saved successfully.");
    }

    private async Task SaveAdminEmail()
    {
        await JS.InvokeVoidAsync("setSetting", "admin_email", adminEmail);
        NotificationService.ShowSuccess("Admin Email saved successfully.");
    }
    
    private async Task SetTheme(string theme)
    {
        themePreference = theme;
        await ThemeService.SetThemeAsync(theme);
        // Optional: Show a toast? Probably not needed for immediate feedback.
    }

    private async Task ToggleNotifications()
    {
        notificationsEnabled = !notificationsEnabled;
        await JS.InvokeVoidAsync("setSetting", "notifications_enabled", notificationsEnabled.ToString());
    }

    private async Task ToggleEmailAlerts()
    {
        emailAlertsEnabled = !emailAlertsEnabled;
        await JS.InvokeVoidAsync("setSetting", "email_alerts_enabled", emailAlertsEnabled.ToString());
    }
    
    private async Task ToggleM365()
    {
        if (isM365Connected)
        {
            await GraphService.LogoutAsync();
            isM365Connected = false;
        }
        else
        {
            await GraphService.LoginAsync("client_id_placeholder");
            isM365Connected = true;
            NotificationService.ShowSuccess("Connected to Microsoft 365 (Demo Mode)");
        }
    }

    // Access Control
    private async Task LoadRoles()
    {
        try
        {
            roles = await SystemService.GetRolesAsync() ?? new List<Role>();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load roles: " + ex.Message);
            roles = new List<Role>();
        }
    }

    private async Task LoadPermissions()
    {
        try
        {
            permissions = await SystemService.GetPermissionsAsync() ?? new List<Permission>();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load permissions: " + ex.Message);
            permissions = new List<Permission>();
        }
    }

    private async Task SelectRole(Role role)
    {
        selectedRole = role;
        rolePermissionIds.Clear();
        if (role.Id.HasValue)
        {
            try
            {
                var ids = await SystemService.GetRolePermissionsAsync(role.Id.Value) ?? new List<int>();
                foreach (var id in ids) rolePermissionIds.Add(id);
            }
            catch (Exception ex)
            {
                NotificationService.ShowError("Failed to load role permissions: " + ex.Message);
            }
        }
    }

    private void TogglePermission(int permId, object? checkedValue)
    {
        if (checkedValue is bool isChecked)
        {
            if (isChecked) rolePermissionIds.Add(permId);
            else rolePermissionIds.Remove(permId);
        }
    }

    private async Task SaveRolePermissions()
    {
        if (selectedRole == null || !selectedRole.Id.HasValue) return;
        try
        {
            await SystemService.UpdateRolePermissionsAsync(selectedRole.Id.Value, rolePermissionIds.ToList());
            await JS.InvokeVoidAsync("notify", "Permissions saved!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("notify", "Error saving permissions: " + ex.Message);
        }
    }

    private void OpenAddRoleModal()
    {
        newRoleName = "";
        newRoleDescription = "";
        showAddRoleModal = true;
    }

    private async Task SaveNewRole()
    {
        if (string.IsNullOrWhiteSpace(newRoleName)) return;
        try
        {
            await SystemService.AddRoleAsync(newRoleName, newRoleDescription);
            showAddRoleModal = false;
            await LoadRoles();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("notify", "Failed to save new role: " + ex.Message);
        }
    }

    // Features
    private async Task LoadFeatureToggles()
    {
        try
        {
            featureToggles = await SystemService.GetFeatureTogglesAsync() ?? new List<FeatureToggle>();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load feature toggles: " + ex.Message);
            featureToggles = new List<FeatureToggle>();
        }
    }

    private async Task ToggleFeature(FeatureToggle toggle)
    {
        toggle.IsEnabled = !toggle.IsEnabled;
        try
        {
            await SystemService.SetFeatureToggleAsync(toggle.Key, toggle.IsEnabled);
            // Optionally notify or refresh
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to toggle feature: " + ex.Message);
        }
    }

    // System
    private void RunSetupWizard()
    {
        Navigation.NavigateTo("/setup");
    }

    private async Task SeedDemoDataAsync()
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to generate demo data? This will add sample services, employees, products, and clients to your database.");
        if (confirm)
        {
            try
            {
                await SystemService.SeedDemoDataAsync();
                NotificationService.ShowSuccess("Demo data generated successfully!");
            }
            catch (Exception ex)
            {
                NotificationService.ShowError("Error generating demo data: " + ex.Message);
            }
        }
    }

    private async Task ResetDatabaseAsync()
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to reset the database? This will permanently delete all data and re-initialize the application.");
        if (confirm)
        {
            try
            {
                await SystemService.ResetDatabaseAsync();
                await JS.InvokeVoidAsync("resetApp");
                
                if (AuthStateProvider is CustomAuthenticationStateProvider customAuth)
                {
                    customAuth.NotifyUserLogout();
                }
                
                await JS.InvokeVoidAsync("notify", "Database reset successful. You will be redirected to the setup wizard.");
                Navigation.NavigateTo("/setup", true);
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("notify", "Error resetting database: " + ex.Message);
            }
        }
    }

    // Audit
    private async Task LoadAuditLogs()
    {
        try
        {
            string? dFrom = auditDateFrom?.ToString("yyyy-MM-dd");
            string? dTo = auditDateTo?.ToString("yyyy-MM-dd");
            auditLogs = await SystemService.GetAuditLogsAsync(auditPage, 50, auditUserId, auditAction, auditCategory, dFrom, dTo) ?? new List<AuditLog>();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("notify", "Failed to load audit logs: " + ex.Message);
            auditLogs = new List<AuditLog>();
        }
    }

    private async Task FilterLogs()
    {
        auditPage = 1;
        await LoadAuditLogs();
    }

    private async Task ExportLogs()
    {
        try
        {
            var csv = await SystemService.ExportAuditLogsAsync();
            var bytes = System.Text.Encoding.UTF8.GetBytes(csv);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("saveAsFile", $"audit_logs_{DateTime.Now:yyyyMMddHHmmss}.csv", base64, "text/csv");
            await JS.InvokeVoidAsync("notify", "Export successful!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("notify", "Export failed: " + ex.Message);
        }
    }

    private async Task PrevPage()
    {
        if (auditPage > 1)
        {
            auditPage--;
            await LoadAuditLogs();
        }
    }

    private async Task NextPage()
    {
        auditPage++;
        await LoadAuditLogs();
    }
}
