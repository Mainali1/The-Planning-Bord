@page "/settings"
@attribute [Authorize]
@inject ISystemService SystemService
@inject IJSRuntime JS
@inject MicrosoftGraphService GraphService
@inject NavigationManager Navigation
@using ThePlanningBord.Services

<PageTitle>Settings - The Planning Bord</PageTitle>

<div class="flex h-full bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-800">Settings</h2>
            <p class="text-xs text-gray-500 mt-1">Manage application preferences</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <button @onclick='() => ChangeTab("general")' class="@GetTabClass("general") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                General
            </button>
            <button @onclick='() => ChangeTab("access")' class="@GetTabClass("access") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Access Control
            </button>
            <button @onclick='() => ChangeTab("features")' class="@GetTabClass("features") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Features & Toggles
            </button>
            <button @onclick='() => ChangeTab("audit")' class="@GetTabClass("audit") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                Audit Logs
            </button>
            <button @onclick='() => ChangeTab("system")' class="@GetTabClass("system") w-full text-left px-6 py-3 text-sm font-medium transition-colors">
                System
            </button>
        </nav>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-auto p-8">
        @if (activeTab == "general")
        {
            <div class="max-w-4xl space-y-6">
                <!-- Appearance -->
                <section class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                         <h3 class="text-lg font-medium text-gray-900">Appearance</h3>
                         <p class="text-sm text-gray-500">Customize the look and feel of the application.</p>
                    </div>
                    <div class="p-6 flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Dark Mode</h4>
                            <p class="text-sm text-gray-500">Use dark theme for the application.</p>
                        </div>
                        <div class="flex items-center">
                            <button type="button" @onclick="ToggleDarkMode" class="@(darkModeEnabled ? "bg-blue-600" : "bg-gray-200") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <span class="@(darkModeEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Notifications -->
                <section class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                         <h3 class="text-lg font-medium text-gray-900">Notifications</h3>
                         <p class="text-sm text-gray-500">Manage how you receive alerts and updates.</p>
                    </div>
                    <div class="p-6 flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Push Notifications</h4>
                            <p class="text-sm text-gray-500">Get notified when stock is low or tasks are due.</p>
                        </div>
                        <div class="flex items-center">
                            <button type="button" @onclick="ToggleNotifications" class="@(notificationsEnabled ? "bg-blue-600" : "bg-gray-200") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <span class="@(notificationsEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Integrations Link -->
                <section class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                         <h3 class="text-lg font-medium text-gray-900">Integrations</h3>
                         <p class="text-sm text-gray-500">Connect external tools and services.</p>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Manage Integrations</h4>
                                <p class="text-sm text-gray-500">Connect with QuickBooks, Salesforce, Slack, and more.</p>
                            </div>
                            <button @onclick='() => Navigation.NavigateTo("/integrations")' class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Configure Integrations
                            </button>
                        </div>
                    </div>
                </section>

                <div class="flex justify-end pt-4">
                    <button type="button" @onclick="SaveGeneralSettings" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        }
        else if (activeTab == "access")
        {
            <div class="bg-white shadow rounded-lg p-6 h-full flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Roles List -->
                    <div class="col-span-1 border-r border-gray-200 pr-4 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h4 class="text-lg font-medium text-gray-900">Roles</h4>
                            <button @onclick="OpenAddRoleModal" class="text-sm text-blue-600 hover:text-blue-900 font-medium">+ Add Role</button>
                        </div>
                        <ul class="divide-y divide-gray-200 overflow-y-auto flex-1">
                            @if (roles != null)
                            {
                                @foreach (var role in roles)
                                {
                                    <li class="py-3 px-2 rounded hover:bg-gray-50 cursor-pointer @(selectedRole?.Id == role.Id ? "bg-blue-50" : "")" @onclick="() => SelectRole(role)">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">@role.Name</p>
                                                <p class="text-xs text-gray-500">@role.Description</p>
                                            </div>
                                            @if (role.IsCustom)
                                            {
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Custom</span>
                                            }
                                        </div>
                                    </li>
                                }
                            }
                        </ul>
                    </div>
                    
                    <!-- Permissions -->
                    <div class="col-span-2 flex flex-col h-full overflow-hidden">
                        @if (selectedRole != null)
                        {
                            <div class="mb-4 flex-shrink-0">
                                <h4 class="text-lg font-medium text-gray-900">Permissions: @selectedRole.Name</h4>
                                <p class="text-sm text-gray-500">Configure access rights for this role.</p>
                            </div>
                            <div class="flex-1 overflow-y-auto pr-2">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    @if (permissions != null)
                                    {
                                        @foreach (var perm in permissions)
                                        {
                                            <div class="relative flex items-start p-2 rounded hover:bg-gray-50">
                                                <div class="flex items-center h-5">
                                                    <input id="perm-@perm.Id" type="checkbox" checked="@(rolePermissionIds.Contains(perm.Id))" @onchange="@(e => TogglePermission(perm.Id, e.Value))" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" />
                                                </div>
                                                <div class="ml-3 text-sm">
                                                    <label for="perm-@perm.Id" class="font-medium text-gray-700 cursor-pointer">@perm.Code</label>
                                                    <p class="text-gray-500 text-xs">@perm.Description</p>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end flex-shrink-0">
                                <button @onclick="SaveRolePermissions" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Save Permissions</button>
                            </div>
                        }
                        else
                        {
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <div class="text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">No role selected</h3>
                                    <p class="mt-1 text-sm text-gray-500">Select a role from the list to view and edit permissions.</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "features")
        {
            <div class="max-w-4xl space-y-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Feature Management</h3>
                    <p class="text-sm text-gray-500">Enable or disable system modules and experimental features.</p>
                </div>
                @if (featureToggles != null)
                {
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <ul class="divide-y divide-gray-200">
                            @foreach (var toggle in featureToggles)
                            {
                                <li class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-gray-900">@toggle.Key</span>
                                        <span class="text-sm text-gray-500">Controls visibility of the @toggle.Key module</span>
                                    </div>
                                    <button type="button" @onclick="() => ToggleFeature(toggle)" class="@(toggle.IsEnabled ? "bg-green-500" : "bg-gray-200") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span aria-hidden="true" class="@(toggle.IsEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
        else if (activeTab == "audit")
        {
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h4 class="text-lg font-medium text-gray-900">System Audit Logs</h4>
                    <p class="text-sm text-gray-500">Track all changes and access events.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @if (auditLogs != null)
                            {
                                @foreach (var log in auditLogs)
                                {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.CreatedAt</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">User @log.UserId</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                @log.Action
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.Entity (@log.EntityId)</td>
                                        <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs" title="@log.Details">@log.Details</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Loading logs...</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <button class="px-3 py-1 border border-gray-300 rounded-md bg-white text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50" @onclick="PrevPage" disabled="@(auditPage == 1)">Previous</button>
                    <span class="text-sm text-gray-600">Page @auditPage</span>
                    <button class="px-3 py-1 border border-gray-300 rounded-md bg-white text-sm text-gray-600 hover:bg-gray-50" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
        else if (activeTab == "system")
        {
             <div class="max-w-4xl space-y-6">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <h4 class="text-lg font-medium text-gray-900">System Configuration</h4>
                        <p class="text-sm text-gray-500">Advanced settings and maintenance tools.</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700 font-medium">
                                        Warning
                                    </p>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        Advanced system operations should only be performed by Technical Support or Administrators. Improper changes may affect system stability.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h5 class="text-sm font-medium text-gray-900 mb-2">Setup & Maintenance</h5>
                            <button @onclick="RunSetupWizard" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Run Setup Wizard
                            </button>
                        </div>
                    </div>
                </div>
             </div>
        }
    </div>
</div>

@if (showAddRoleModal)
{
    <div class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Role</h3>
                    <div class="mt-4 grid grid-cols-1 gap-y-4">
                        <input type="text" @bind="newRoleName" placeholder="Role Name" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" />
                        <input type="text" @bind="newRoleDescription" placeholder="Description" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" />
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @onclick="SaveNewRole" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                    <button type="button" @onclick="() => showAddRoleModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "general";
    private bool notificationsEnabled;
    private bool darkModeEnabled;
    private bool isM365Connected;
    
    // Access Control
    private List<Role>? roles;
    private List<Permission>? permissions;
    private Role? selectedRole;
    private HashSet<int> rolePermissionIds = new HashSet<int>();
    private bool showAddRoleModal = false;
    private string newRoleName = "";
    private string newRoleDescription = "";

    // Features
    private List<FeatureToggle>? featureToggles;

    // Audit
    private List<AuditLog>? auditLogs;
    private int auditPage = 1;

    protected override async Task OnInitializedAsync()
    {
        var enabledStr = await JS.InvokeAsync<string>("getSetting", "notifications_enabled");
        bool.TryParse(enabledStr, out notificationsEnabled);
        var darkStr = await JS.InvokeAsync<string>("getSetting", "dark_mode_enabled");
        bool.TryParse(darkStr, out darkModeEnabled);
        
        isM365Connected = await GraphService.IsConnected();

        await LoadRoles();
        await LoadPermissions();
        await LoadFeatureToggles();
        await LoadAuditLogs();
    }

    private string GetTabClass(string tab)
    {
        return activeTab == tab 
            ? "bg-blue-50 text-blue-700 border-r-4 border-blue-600" 
            : "text-gray-600 hover:bg-gray-50 hover:text-gray-900";
    }

    private void ChangeTab(string tab)
    {
        activeTab = tab;
    }

    // General
    private async Task SaveGeneralSettings()
    {
        await JS.InvokeVoidAsync("setSetting", "notifications_enabled", notificationsEnabled.ToString());
        await JS.InvokeVoidAsync("setSetting", "dark_mode_enabled", darkModeEnabled.ToString());
        await JS.InvokeVoidAsync("applyTheme", darkModeEnabled ? "dark" : "light");
        await JS.InvokeVoidAsync("notify", "Settings saved successfully!");
    }
    
    private void ToggleDarkMode() => darkModeEnabled = !darkModeEnabled;
    private void ToggleNotifications() => notificationsEnabled = !notificationsEnabled;
    
    private async Task ToggleM365()
    {
        if (isM365Connected)
        {
            await GraphService.LogoutAsync();
            isM365Connected = false;
        }
        else
        {
            await GraphService.LoginAsync("client_id_placeholder");
            isM365Connected = true;
            await JS.InvokeVoidAsync("notify", "Connected to Microsoft 365 (Demo Mode)");
        }
    }

    // Access Control
    private async Task LoadRoles()
    {
        try { roles = await SystemService.GetRolesAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); roles = new List<Role>(); }
    }

    private async Task LoadPermissions()
    {
        try { permissions = await SystemService.GetPermissionsAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); permissions = new List<Permission>(); }
    }

    private async Task SelectRole(Role role)
    {
        selectedRole = role;
        rolePermissionIds.Clear();
        if (role.Id.HasValue)
        {
            try
            {
                var ids = await SystemService.GetRolePermissionsAsync(role.Id.Value);
                foreach (var id in ids) rolePermissionIds.Add(id);
            }
            catch (Exception ex) { Console.WriteLine(ex.Message); }
        }
    }

    private void TogglePermission(int permId, object? checkedValue)
    {
        if (checkedValue is bool isChecked)
        {
            if (isChecked) rolePermissionIds.Add(permId);
            else rolePermissionIds.Remove(permId);
        }
    }

    private async Task SaveRolePermissions()
    {
        if (selectedRole == null || !selectedRole.Id.HasValue) return;
        try
        {
            await SystemService.UpdateRolePermissionsAsync(selectedRole.Id.Value, rolePermissionIds.ToList());
            await JS.InvokeVoidAsync("notify", "Permissions saved!");
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); await JS.InvokeVoidAsync("notify", "Error saving permissions"); }
    }

    private void OpenAddRoleModal()
    {
        newRoleName = "";
        newRoleDescription = "";
        showAddRoleModal = true;
    }

    private async Task SaveNewRole()
    {
        if (string.IsNullOrWhiteSpace(newRoleName)) return;
        try
        {
            await SystemService.AddRoleAsync(newRoleName, newRoleDescription);
            showAddRoleModal = false;
            await LoadRoles();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // Features
    private async Task LoadFeatureToggles()
    {
        try { featureToggles = await SystemService.GetFeatureTogglesAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); featureToggles = new List<FeatureToggle>(); }
    }

    private async Task ToggleFeature(FeatureToggle toggle)
    {
        toggle.IsEnabled = !toggle.IsEnabled;
        try
        {
            await SystemService.SetFeatureToggleAsync(toggle.Key, toggle.IsEnabled);
            // Optionally notify or refresh
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // System
    private void RunSetupWizard()
    {
        Navigation.NavigateTo("/setup");
    }

    // Audit
    private async Task LoadAuditLogs()
    {
        try
        {
            auditLogs = await SystemService.GetAuditLogsAsync(auditPage, 50);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            auditLogs = new List<AuditLog>();
        }
    }

    private async Task PrevPage()
    {
        if (auditPage > 1)
        {
            auditPage--;
            await LoadAuditLogs();
        }
    }

    private async Task NextPage()
    {
        auditPage++;
        await LoadAuditLogs();
    }
}
