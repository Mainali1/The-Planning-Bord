@page "/settings"
@inject ISystemService SystemService
@inject IJSRuntime JS
@inject MicrosoftGraphService GraphService
@inject NavigationManager Navigation
@using ThePlanningBord.Services

<PageTitle>Settings - The Planning Bord</PageTitle>

<div class="flex flex-col h-full">
    <div class="mb-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Settings</h3>
        <div class="mt-3 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button @onclick='() => ChangeTab("general")' class="@(activeTab == "general" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">General</button>
                <button @onclick='() => ChangeTab("access")' class="@(activeTab == "access" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Access Control</button>
                <button @onclick='() => ChangeTab("features")' class="@(activeTab == "features" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Features</button>
                <button @onclick='() => ChangeTab("audit")' class="@(activeTab == "audit" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Audit Logs</button>
                <button @onclick='() => ChangeTab("system")' class="@(activeTab == "system" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">System</button>
            </nav>
        </div>
    </div>

    <div class="flex-1 overflow-auto bg-white shadow rounded-lg p-6">
        @if (activeTab == "general")
        {
            <div class="space-y-6">
                <div>
                    <h4 class="text-base font-medium text-gray-900">General Settings</h4>
                    <p class="text-sm text-gray-500">Application preferences and configuration.</p>
                </div>
                
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="notifications" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" @bind="notificationsEnabled" />
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="notifications" class="font-medium text-gray-700">Enable Notifications</label>
                        <p class="text-sm text-gray-500">Get notified when stock is low or tasks are due.</p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="dark_mode" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" @bind="darkModeEnabled" />
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="dark_mode" class="font-medium text-gray-700">Dark Mode</label>
                        <p class="text-gray-500">Use dark theme for the application.</p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-base font-medium text-gray-900">Integrations</h4>
                    <div class="mt-4 flex items-center justify-between">
                        <div>
                            <h5 class="text-sm font-medium text-gray-900">Microsoft 365</h5>
                            <p class="text-sm text-gray-500">Connect Outlook to send auto-restock emails.</p>
                        </div>
                        <button type="button" @onclick="ToggleM365" class="@(isM365Connected ? "bg-red-100 text-red-700 hover:bg-red-200" : "bg-blue-100 text-blue-700 hover:bg-blue-200") px-4 py-2 rounded-md text-sm font-medium">
                            @(isM365Connected ? "Disconnect" : "Connect")
                        </button>
                    </div>
                </div>

                <div class="pt-5">
                    <div class="flex justify-end">
                        <button type="button" @onclick="SaveGeneralSettings" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Save</button>
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "access")
        {
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 border-r border-gray-200 pr-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-900">Roles</h4>
                        <button @onclick="OpenAddRoleModal" class="text-sm text-blue-600 hover:text-blue-900 font-medium">+ Add Role</button>
                    </div>
                    <ul class="divide-y divide-gray-200">
                        @if (roles != null)
                        {
                            @foreach (var role in roles)
                            {
                                <li class="py-3 flex justify-between items-center cursor-pointer @(selectedRole?.Id == role.Id ? "bg-blue-50" : "")" @onclick="() => SelectRole(role)">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">@role.Name</p>
                                        <p class="text-xs text-gray-500">@role.Description</p>
                                    </div>
                                    @if (role.IsCustom)
                                    {
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Custom</span>
                                    }
                                </li>
                            }
                        }
                    </ul>
                </div>
                <div class="col-span-2">
                    @if (selectedRole != null)
                    {
                        <div class="mb-4">
                            <h4 class="text-lg font-medium text-gray-900">Permissions for @selectedRole.Name</h4>
                            <p class="text-sm text-gray-500">Select the permissions assigned to this role.</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            @if (permissions != null)
                            {
                                @foreach (var perm in permissions)
                                {
                                    <div class="relative flex items-start">
                                        <div class="flex items-center h-5">
                                            <input id="perm-@perm.Id" type="checkbox" checked="@(rolePermissionIds.Contains(perm.Id))" @onchange="@(e => TogglePermission(perm.Id, e.Value))" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" />
                                        </div>
                                        <div class="ml-3 text-sm">
                                            <label for="perm-@perm.Id" class="font-medium text-gray-700">@perm.Code</label>
                                            <p class="text-gray-500">@perm.Description</p>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button @onclick="SaveRolePermissions" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Save Permissions</button>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-10 text-gray-500">Select a role to view permissions.</div>
                    }
                </div>
            </div>
        }
        else if (activeTab == "features")
        {
            <div class="space-y-6">
                <div>
                    <h4 class="text-base font-medium text-gray-900">Feature Toggles</h4>
                    <p class="text-sm text-gray-500">Enable or disable system features globally.</p>
                </div>
                @if (featureToggles != null)
                {
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <ul class="divide-y divide-gray-200">
                            @foreach (var toggle in featureToggles)
                            {
                                <li class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-900">@toggle.Key</span>
                                            <span class="text-sm text-gray-500">Description for @toggle.Key</span>
                                        </div>
                                        <div class="flex items-center">
                                            <button type="button" @onclick="() => ToggleFeature(toggle)" class="@(toggle.IsEnabled ? "bg-blue-600" : "bg-gray-200") relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" role="switch" aria-checked="@toggle.IsEnabled">
                                                <span aria-hidden="true" class="@(toggle.IsEnabled ? "translate-x-5" : "translate-x-0") pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
        else if (activeTab == "audit")
        {
            <div class="flex flex-col">
                <div class="mb-4">
                    <h4 class="text-base font-medium text-gray-900">Audit Logs</h4>
                    <p class="text-sm text-gray-500">View system activity and user actions.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @if (auditLogs != null)
                            {
                                @foreach (var log in auditLogs)
                                {
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.CreatedAt</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">User @log.UserId</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@log.Action</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.Entity (@log.EntityId)</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">@log.Details</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Loading logs...</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between">
                    <button class="px-3 py-1 border rounded text-sm text-gray-600 hover:bg-gray-50" @onclick="PrevPage" disabled="@(auditPage == 1)">Previous</button>
                    <span class="text-sm text-gray-600 self-center">Page @auditPage</span>
                    <button class="px-3 py-1 border rounded text-sm text-gray-600 hover:bg-gray-50" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
        else if (activeTab == "system")
        {
             <div class="space-y-6">
                <div>
                    <h4 class="text-base font-medium text-gray-900">System Configuration</h4>
                    <p class="text-sm text-gray-500">Manage system-level settings and setup.</p>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <!-- Warning Icon -->
                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Warning: Advanced system operations should only be performed by Technical Support.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button @onclick="RunSetupWizard" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Run Setup Wizard
                    </button>
                </div>
             </div>
        }
    </div>
</div>

@if (showAddRoleModal)
{
    <div class="fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Role</h3>
                    <div class="mt-4 grid grid-cols-1 gap-y-4">
                        <input type="text" @bind="newRoleName" placeholder="Role Name" class="block w-full border-gray-300 rounded-md shadow-sm" />
                        <input type="text" @bind="newRoleDescription" placeholder="Description" class="block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @onclick="SaveNewRole" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                    <button type="button" @onclick="() => showAddRoleModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "general";
    private bool notificationsEnabled;
    private bool darkModeEnabled;
    private bool isM365Connected;
    
    // Access Control
    private List<Role>? roles;
    private List<Permission>? permissions;
    private Role? selectedRole;
    private HashSet<int> rolePermissionIds = new HashSet<int>();
    private bool showAddRoleModal = false;
    private string newRoleName = "";
    private string newRoleDescription = "";

    // Features
    private List<FeatureToggle>? featureToggles;

    // Audit
    private List<AuditLog>? auditLogs;
    private int auditPage = 1;

    protected override async Task OnInitializedAsync()
    {
        var enabledStr = await JS.InvokeAsync<string>("getSetting", "notifications_enabled");
        bool.TryParse(enabledStr, out notificationsEnabled);
        var darkStr = await JS.InvokeAsync<string>("getSetting", "dark_mode_enabled");
        bool.TryParse(darkStr, out darkModeEnabled);
        
        isM365Connected = await GraphService.IsConnected();

        await LoadRoles();
        await LoadPermissions();
        await LoadFeatureToggles();
        await LoadAuditLogs();
    }

    private void ChangeTab(string tab)
    {
        activeTab = tab;
    }

    // General
    private async Task SaveGeneralSettings()
    {
        await JS.InvokeVoidAsync("setSetting", "notifications_enabled", notificationsEnabled.ToString());
        await JS.InvokeVoidAsync("setSetting", "dark_mode_enabled", darkModeEnabled.ToString());
        await JS.InvokeVoidAsync("applyTheme", darkModeEnabled ? "dark" : "light");
        await JS.InvokeVoidAsync("notify", "Settings saved successfully!");
    }
    
    private async Task ToggleM365()
    {
        if (isM365Connected)
        {
            await GraphService.LogoutAsync();
            isM365Connected = false;
        }
        else
        {
            await GraphService.LoginAsync("client_id_placeholder");
            isM365Connected = true;
            await JS.InvokeVoidAsync("notify", "Connected to Microsoft 365 (Demo Mode)");
        }
    }

    // Access Control
    private async Task LoadRoles()
    {
        try { roles = await SystemService.GetRolesAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); roles = new List<Role>(); }
    }

    private async Task LoadPermissions()
    {
        try { permissions = await SystemService.GetPermissionsAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); permissions = new List<Permission>(); }
    }

    private async Task SelectRole(Role role)
    {
        selectedRole = role;
        rolePermissionIds.Clear();
        if (role.Id.HasValue)
        {
            try
            {
                var ids = await SystemService.GetRolePermissionsAsync(role.Id.Value);
                foreach (var id in ids) rolePermissionIds.Add(id);
            }
            catch (Exception ex) { Console.WriteLine(ex.Message); }
        }
    }

    private void TogglePermission(int permId, object? checkedValue)
    {
        if (checkedValue is bool isChecked)
        {
            if (isChecked) rolePermissionIds.Add(permId);
            else rolePermissionIds.Remove(permId);
        }
    }

    private async Task SaveRolePermissions()
    {
        if (selectedRole == null || !selectedRole.Id.HasValue) return;
        try
        {
            await SystemService.UpdateRolePermissionsAsync(selectedRole.Id.Value, rolePermissionIds.ToList());
            await JS.InvokeVoidAsync("notify", "Permissions saved!");
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); await JS.InvokeVoidAsync("notify", "Error saving permissions"); }
    }

    private void OpenAddRoleModal()
    {
        newRoleName = "";
        newRoleDescription = "";
        showAddRoleModal = true;
    }

    private async Task SaveNewRole()
    {
        if (string.IsNullOrWhiteSpace(newRoleName)) return;
        try
        {
            await SystemService.AddRoleAsync(newRoleName, newRoleDescription);
            showAddRoleModal = false;
            await LoadRoles();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // Features
    private async Task LoadFeatureToggles()
    {
        try { featureToggles = await SystemService.GetFeatureTogglesAsync(); }
        catch (Exception ex) { Console.WriteLine(ex.Message); featureToggles = new List<FeatureToggle>(); }
    }

    private async Task ToggleFeature(FeatureToggle toggle)
    {
        toggle.IsEnabled = !toggle.IsEnabled;
        try
        {
            await SystemService.SetFeatureToggleAsync(toggle.Key, toggle.IsEnabled);
            // Optionally notify or refresh
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // System
    private void RunSetupWizard()
    {
        Navigation.NavigateTo("/setup");
    }

    // Audit
    private async Task LoadAuditLogs()
    {
        try
        {
            auditLogs = await SystemService.GetAuditLogsAsync(auditPage, 50);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            auditLogs = new List<AuditLog>();
        }
    }

    private async Task PrevPage()
    {
        if (auditPage > 1)
        {
            auditPage--;
            await LoadAuditLogs();
        }
    }

    private async Task NextPage()
    {
        auditPage++;
        await LoadAuditLogs();
    }
}
