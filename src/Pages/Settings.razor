@page "/settings"
@inject ITauriService AppService
@inject IJSRuntime JS

<PageTitle>Settings - The Planning Bord</PageTitle>

<div class="flex flex-col h-full">
    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Settings</h3>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="space-y-6">
            <div>
                <h4 class="text-base font-medium text-gray-900">General Settings</h4>
                <p class="text-sm text-gray-500">Application preferences and configuration.</p>
            </div>
            
            <div class="flex items-start">
                <div class="flex items-center h-5">
                    <input id="notifications" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" @bind="notificationsEnabled" />
                </div>
                <div class="ml-3 text-sm">
                    <label for="notifications" class="font-medium text-gray-700">Enable Notifications</label>
                    <p class="text-sm text-gray-500">Get notified when stock is low or tasks are due.</p>
                </div>
            </div>

            <div class="flex items-start">
                <div class="flex items-center h-5">
                    <input id="dark_mode" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" />
                </div>
                <div class="ml-3 text-sm">
                    <label for="dark_mode" class="font-medium text-gray-700">Dark Mode</label>
                    <p class="text-gray-500">Use dark theme for the application.</p>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-base font-medium text-gray-900">Integrations</h4>
                <div class="mt-4 flex items-center justify-between">
                    <div>
                        <h5 class="text-sm font-medium text-gray-900">Microsoft 365</h5>
                        <p class="text-sm text-gray-500">Connect Outlook to send auto-restock emails.</p>
                    </div>
                    <button type="button" @onclick="ToggleM365" class="@(isM365Connected ? "bg-red-100 text-red-700 hover:bg-red-200" : "bg-blue-100 text-blue-700 hover:bg-blue-200") px-4 py-2 rounded-md text-sm font-medium">
                        @(isM365Connected ? "Disconnect" : "Connect")
                    </button>
                </div>
            </div>

            <div class="pt-5">
                <div class="flex justify-end">
                    <button type="button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">Cancel</button>
                    <button type="button" @onclick="SaveSettings" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool notificationsEnabled;
    private bool isM365Connected;
    [Inject] private MicrosoftGraphService GraphService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var enabledStr = await JS.InvokeAsync<string>("getSetting", "notifications_enabled");
        bool.TryParse(enabledStr, out notificationsEnabled);
        
        isM365Connected = await GraphService.IsConnected();
    }

    private async Task SaveSettings()
    {
        await JS.InvokeVoidAsync("setSetting", "notifications_enabled", notificationsEnabled.ToString());
        // Show success message
        await JS.InvokeVoidAsync("notify", "Settings saved successfully!");
    }
    
    private async Task ToggleM365()
    {
        if (isM365Connected)
        {
            await GraphService.LogoutAsync();
            isM365Connected = false;
        }
        else
        {
            await GraphService.LoginAsync("client_id_placeholder");
            isM365Connected = true;
            await JS.InvokeVoidAsync("notify", "Connected to Microsoft 365 (Demo Mode)");
        }
    }
}
