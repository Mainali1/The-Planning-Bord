@page "/attendance"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthStateProvider
@inject IHrService HrService
@using ThePlanningBord.Models
@using System.Security.Claims
@inject IJSRuntime JS
@inject NotificationService NotificationService
@using ThePlanningBord.Services

<PageTitle>Attendance - The Planning Bord</PageTitle>

<div class="flex flex-col h-full">
    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Attendance Tracking</h3>
    
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h4 class="text-base font-medium text-gray-900 mb-4">Clock In/Out</h4>
        <div class="flex gap-4">
            <button @onclick="ClockIn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50" disabled="@isClockedIn">Clock In</button>
            <button @onclick="ClockOut" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50" disabled="@(!isClockedIn)">Clock Out</button>
        </div>
    </div>

    <div class="flex-1 overflow-auto bg-white shadow rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @onclick="SetSortByName">Employee</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @onclick="SetSortByDate">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @onclick="SetSortByIn">Clock In</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @onclick="SetSortByOut">Clock Out</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @onclick="SetSortByDuration">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @if (attendances == null) { <tr><td colspan="5" class="px-6 py-4 text-center">Loading...</td></tr> }
                else if (!attendances.Any()) { <tr><td colspan="5" class="px-6 py-4 text-center">No attendance records found.</td></tr> }
                else
                {
                    @foreach (var a in GetSortedAttendances())
                    {
                        var emp = employees?.FirstOrDefault(e => e.Id == a.EmployeeId);
                        var (inDt, outDt) = ParseTimes(a.CheckIn, a.CheckOut);
                        var dateStr = inDt?.ToString("yyyy-MM-dd");
                        var inStr = inDt?.ToString("HH:mm:ss");
                        var outStr = outDt?.ToString("HH:mm:ss");
                        var durationStr = (inDt.HasValue && outDt.HasValue) ? (outDt.Value - inDt.Value).ToString(@"hh\:mm\:ss") : "â€”";
                        var late = inDt.HasValue && inDt.Value.TimeOfDay > WorkdayStart.Add(DefaultLateGrace);
                        var early = outDt.HasValue && outDt.Value.TimeOfDay < WorkdayEnd;
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@(emp != null ? $"{emp.FirstName} {emp.LastName}" : $"ID {a.EmployeeId}")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@dateStr</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @inStr
                                @if (late)
                                {
                                    <span class="ml-2 inline-block w-2 h-2 rounded-full bg-red-500" title="Late arrival"></span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @outStr
                                @if (early)
                                {
                                    <span class="ml-2 inline-block w-2 h-2 rounded-full bg-yellow-500" title="Early departure"></span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@durationStr</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @(a.Status == "present" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800")">
                                    @a.Status
                                </span>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    
    <div class="mt-2 flex items-center gap-6 text-sm text-gray-600 px-1">
        <span class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-red-500"></span> 
            <span>Late Arrival (&gt; @WorkdayStart.Add(DefaultLateGrace).ToString(@"hh\:mm"))</span>
        </span>
        <span class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-yellow-500"></span> 
            <span>Early Departure (&lt; @WorkdayEnd.ToString(@"hh\:mm"))</span>
        </span>
    </div>
</div>

@code {
    private List<AttendanceModel>? attendances;
    private bool isClockedIn = false;
    private List<Employee>? employees;
    private string sortBy = "date";
    private bool sortAsc = true;
    private static readonly TimeSpan WorkdayStart = new TimeSpan(9, 0, 0);
    private static readonly TimeSpan WorkdayEnd = new TimeSpan(17, 0, 0);
    private static readonly TimeSpan DefaultLateGrace = new TimeSpan(0, 15, 0);
    
    private int? currentUserId;
    private ClaimsPrincipal? user;

    protected override async Task OnInitializedAsync()
    {
         var authState = await AuthStateProvider.GetAuthenticationStateAsync();
         user = authState.User;
         if (user.Identity?.IsAuthenticated == true)
         {
             var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
             if (idClaim != null && int.TryParse(idClaim.Value, out int id))
             {
                 currentUserId = id;
             }
         }

         try { employees = await HrService.GetEmployeesAsync() ?? new List<Employee>(); } catch {}
         await LoadAttendances();
         CheckCurrentStatus();
    }

    private void CheckCurrentStatus()
    {
        // Simple logic: if last record for today has no checkout time, user is clocked in.
        // In real app, this should be an API call or check session.
        if (attendances != null && attendances.Any())
        {
            var last = attendances.OrderByDescending(a => a.CheckIn).FirstOrDefault();
            if (last != null && IsToday(last.CheckIn) && string.IsNullOrEmpty(last.CheckOut))
            {
                isClockedIn = true;
            }
            else
            {
                isClockedIn = false;
            }
        }
    }

    private async Task LoadAttendances()
    {
        try 
        { 
            attendances = await HrService.GetAttendancesAsync() ?? new List<AttendanceModel>();
            CheckCurrentStatus();
        }
        catch (Exception ex) 
        { 
            NotificationService.ShowError("Failed to load attendance records: " + ex.Message);
            attendances = new List<AttendanceModel>(); 
        }
    }

    private IEnumerable<AttendanceModel> GetSortedAttendances()
    {
        var query = attendances?.AsEnumerable() ?? Enumerable.Empty<AttendanceModel>();
        switch (sortBy)
        {
            case "name":
                query = query.OrderBy(a => GetEmployeeName(a.EmployeeId)).ThenBy(a => a.CheckIn);
                break;
            case "in":
                query = query.OrderBy(a => ParseTimes(a.CheckIn, a.CheckOut).Item1);
                break;
            case "out":
                query = query.OrderBy(a => ParseTimes(a.CheckIn, a.CheckOut).Item2);
                break;
            case "duration":
                query = query.OrderBy(a => GetDurationMinutes(a));
                break;
            case "date":
            default:
                query = query.OrderBy(a => ParseTimes(a.CheckIn, a.CheckOut).Item1?.Date);
                break;
        }
        if (!sortAsc) query = query.Reverse();
        return query;
    }

    private void SetSort(string key)
    {
        if (sortBy == key) { sortAsc = !sortAsc; }
        else { sortBy = key; sortAsc = true; }
    }
    private void SetSortByName() => SetSort("name");
    private void SetSortByDate() => SetSort("date");
    private void SetSortByIn() => SetSort("in");
    private void SetSortByOut() => SetSort("out");
    private void SetSortByDuration() => SetSort("duration");

    private string GetEmployeeName(int? id)
    {
        var emp = employees?.FirstOrDefault(e => e.Id == id);
        return emp != null ? $"{emp.FirstName} {emp.LastName}" : $"ID {id}";
    }

    private (DateTime?, DateTime?) ParseTimes(string checkIn, string? checkOut)
    {
        DateTime? inDt = null;
        DateTime? outDt = null;
        if (DateTime.TryParse(checkIn, out var cin)) inDt = cin;
        if (!string.IsNullOrEmpty(checkOut) && DateTime.TryParse(checkOut, out var cout)) outDt = cout;
        return (inDt, outDt);
    }

    private int GetDurationMinutes(AttendanceModel a)
    {
        var (inDt, outDt) = ParseTimes(a.CheckIn, a.CheckOut);
        if (inDt.HasValue && outDt.HasValue)
        {
            return (int)(outDt.Value - inDt.Value).TotalMinutes;
        }
        return 0;
    }

    private async Task ClockIn()
    {
        if (currentUserId == null)
        {
            NotificationService.ShowError("User not authenticated.");
            return;
        }

        var att = new AttendanceModel 
        { 
            EmployeeId = currentUserId.Value, 
            CheckIn = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
            Status = "present"
        };
        try 
        { 
            await HrService.ClockInAsync(att);
            isClockedIn = true;
            await LoadAttendances();
            NotificationService.ShowSuccess("Clocked in successfully.");
        }
        catch (TauriValidationException ex) { NotificationService.ShowError(ex.Message); }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to clock in: " + ex.Message);
        }
    }

    private async Task ClockOut()
    {
         if (currentUserId == null)
         {
             NotificationService.ShowError("User not authenticated.");
             return;
         }

         var open = attendances?
            .Where(a => a.EmployeeId == currentUserId.Value && IsToday(a.CheckIn) && string.IsNullOrEmpty(a.CheckOut))
            .OrderByDescending(a => a.CheckIn)
            .FirstOrDefault();
         if (open?.Id == null) 
         { 
             NotificationService.ShowWarning("No active clock-in found for today."); 
             return; 
         }
         var att = new AttendanceModel 
        { 
            Id = open.Id,
            CheckOut = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
            Status = "present"
        };
        
        try
        {
            await HrService.ClockOutAsync(att);
            NotificationService.ShowSuccess("Clocked out successfully");
            await LoadAttendances();
        }
        catch (TauriValidationException ex) { NotificationService.ShowError(ex.Message); }
        catch (Exception ex) 
        { 
            NotificationService.ShowError("Clock out failed: " + ex.Message); 
        }
    }
    
    private bool IsToday(string checkIn)
    {
        if (DateTime.TryParse(checkIn, out var dt))
        {
            return dt.Date == DateTime.Today;
        }
        return false;
    }
}
