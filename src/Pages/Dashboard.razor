@page "/"
@attribute [Authorize]
@inject IReportService ReportService
@inject IInventoryService InventoryService
@inject ITaskService TaskService
@inject IBusinessConfigurationService BusinessConfigurationService
@inject IJSRuntime JS
@inject NotificationService NotificationService
@using ThePlanningBord.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

<PageTitle>Dashboard - The Planning Bord</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
        <AuthorizeView>
            <Authorized>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Welcome back, <span class="font-medium text-gray-900 dark:text-white">@context.User.Identity?.Name</span> <span class="text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 py-0.5 px-2 rounded-full ml-2">@context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value</span></p>
            </Authorized>
        </AuthorizeView>
    </div>
    <div class="flex space-x-2">
        <button @onclick="ToggleEditMode" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded inline-flex items-center">
            <span>@(editMode ? "Done" : "Customize Layout")</span>
        </button>
        <a href="reports" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
            <span>View Reports</span>
        </a>
    </div>
</div>

<div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-4">
    @if ((businessType == "product-only" || businessType == "both") && ShowWidget("products")) {
    <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Products</div>
        <div class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">@stats.TotalProducts</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("products")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
    @if ((businessType == "product-only" || businessType == "both") && ShowWidget("lowstock")) {
    <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Low Stock Items</div>
        <div class="mt-1 text-3xl font-semibold text-red-600 dark:text-red-400">@stats.LowStockItems</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("lowstock")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
    <AuthorizeView Roles="CEO,Manager">
        @if (ShowWidget("employees")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Employees</div>
            <div class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">@stats.TotalEmployees</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("employees")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if (ShowWidget("revenue")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Est. Revenue</div>
            <div class="mt-1 text-3xl font-semibold text-green-600 dark:text-green-400">@stats.TotalRevenue.ToString("C")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("revenue")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if (ShowWidget("profit")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Net Profit</div>
            <div class="mt-1 text-3xl font-semibold text-green-600 dark:text-green-400">@stats.NetProfit.ToString("C")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("profit")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if (ShowWidget("sales")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Sales Count</div>
            <div class="mt-1 text-3xl font-semibold text-purple-600 dark:text-purple-400">@stats.TotalSales</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("sales")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "product-only" || businessType == "both") && ShowWidget("turnover")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Inventory Turnover</div>
            <div class="mt-1 text-3xl font-semibold text-blue-600 dark:text-blue-400">@inventoryTurnover.ToString("0.0")x</div>
            <div class="text-xs text-green-500 dark:text-green-400">‚ñ≤ 12% vs last month</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("turnover")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("services")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Services</div>
            <div class="mt-1 text-3xl font-semibold text-purple-600 dark:text-purple-400">@stats.TotalServices</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("services")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("clients")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Clients</div>
            <div class="mt-1 text-3xl font-semibold text-cyan-600 dark:text-cyan-400">@stats.TotalClients</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("clients")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("billable")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Billable Hours</div>
            <div class="mt-1 text-3xl font-semibold text-orange-600 dark:text-orange-400">@stats.BillableHours.ToString("F1")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("billable")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("utilization")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Billable Utilization</div>
            <div class="mt-1 text-3xl font-semibold text-blue-500 dark:text-blue-400">@stats.BillableUtilization.ToString("P1")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("utilization")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("margin")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Avg. Project Margin</div>
            <div class="mt-1 text-3xl font-semibold text-green-500 dark:text-green-400">@stats.AverageProjectMargin.ToString("P1")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("margin")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("availability")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Resource Availability</div>
            <div class="mt-1 text-3xl font-semibold text-indigo-500 dark:text-indigo-400">@stats.ResourceAvailabilityRate.ToString("P1")</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("availability")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
        @if ((businessType == "service-only" || businessType == "both") && ShowWidget("contracts")) {
        <div class="w-full px-4 py-5 bg-white dark:bg-gray-800 rounded-lg shadow relative group">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Expiring Contracts</div>
            <div class="mt-1 text-3xl font-semibold text-red-500 dark:text-red-400">@stats.ContractsExpiringSoon</div>
            @if(editMode) { <button @onclick='() => ToggleWidget("contracts")' class="absolute top-2 right-2 text-red-500">Hide</button> }
        </div>
        }
    </AuthorizeView>
</div>

@if (editMode)
{
    <div class="mb-6 p-4 bg-gray-100 rounded border border-gray-300">
        <h3 class="font-bold mb-2">Hidden Widgets</h3>
        <div class="flex space-x-2">
            @foreach(var w in hiddenWidgets)
            {
                <button @onclick="() => ToggleWidget(w)" class="bg-white border border-gray-300 px-3 py-1 rounded text-sm hover:bg-gray-50">Show @w</button>
            }
        </div>
    </div>
}

@if ((businessType == "product-only" || businessType == "both") && lowStockProducts.Any())
{
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 shadow rounded-md">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                    Low Stock Alerts (@lowStockProducts.Count)
                </h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc pl-5 space-y-1">
                        @foreach (var p in lowStockProducts)
                        {
                            <li>
                                <strong>@p.Name</strong> (SKU: @p.Sku) - Only @p.CurrentQuantity left (Min: @p.MinimumQuantity)
                                <a href="inventory" class="font-bold underline ml-2">Restock</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 gap-4">
            @if (businessType == "product-only" || businessType == "both")
            {
                <a href="inventory" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    üì¶ Manage Inventory
                </a>
            }
            @if (businessType == "service-only" || businessType == "both")
            {
                <a href="services" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                    üõ†Ô∏è Manage Services
                </a>
            }
            <a href="tasks" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                ‚úÖ View Tasks
            </a>
            @if (businessType == "service-only" || businessType == "both")
            {
                <a href="clients" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">
                    üë• Manage Clients
                </a>
            }
            <a href="employees" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                üë• Employees
            </a>
            @if (businessType == "service-only" || businessType == "both")
            {
                <a href="time-tracking" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                    ‚è∞ Time Tracking
                </a>
            }
            @if (businessType == "product-only" || businessType == "both")
            {
                <a href="finance" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
                    üí∞ Finance
                </a>
            }
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white mb-4">Cashflow Trend</h3>
        <div class="h-48 flex items-end space-x-2">
             @if (cashflow != null && cashflow.Any())
            {
                var maxVal = cashflow.Max(c => c.Value);
                if (maxVal == 0) maxVal = 1; 
                
                foreach (var point in cashflow)
                {
                    var height = (point.Value / maxVal) * 100;
                    <div class="flex-1 flex flex-col items-center group relative">
                        <div class="w-full bg-green-500 rounded-t hover:bg-green-600 transition-all duration-300" style="height: @height%"></div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 transform -rotate-45 origin-top-left">@point.Label</div>
                         <div class="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 z-10 whitespace-nowrap">
                            @point.Value.ToString("C")
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">No Data Available</div>
            }
        </div>
    </div>
</div>

@code {
    private DashboardStats stats = new();
    private List<Product> lowStockProducts = new();
    private List<ChartDataPoint> cashflow = new();
    private double inventoryTurnover = 0;
    private string businessType = "";
    
    private bool editMode = false;
    private HashSet<string> hiddenWidgets = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBusinessConfiguration();
        await LoadData();
    }

    private async Task LoadBusinessConfiguration()
    {
        try
        {
            var config = await BusinessConfigurationService.GetBusinessConfigurationAsync();
            if (config != null)
            {
                businessType = config.BusinessType.ToLower();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load business configuration: {ex.Message}");
            // Default to both if configuration fails
            businessType = "both";
        }
    }

    private async Task LoadData()
    {
        try
        {
            try
            {
                stats = await ReportService.GetDashboardStatsAsync() ?? new DashboardStats();
            }
            catch (TauriValidationException ex)
            {
                NotificationService.ShowError($"Stats Error: {ex.Message}");
                stats = new DashboardStats();
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to load stats: {ex.Message}");
                stats = new DashboardStats();
            }

            try
            {
                cashflow = await ReportService.GetMonthlyCashflowAsync() ?? new List<ChartDataPoint>();
            }
            catch (TauriValidationException ex)
            {
                NotificationService.ShowError($"Cashflow Error: {ex.Message}");
                cashflow = new List<ChartDataPoint>();
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to load cashflow: {ex.Message}");
                cashflow = new List<ChartDataPoint>();
            }
            
            // Get low stock for alert
            try 
            {
                var productResult = await InventoryService.GetProductsAsync(null, 1, 1000);
                if (productResult != null && productResult.Items != null)
                {
                    lowStockProducts = productResult.Items.Where(p => p.CurrentQuantity <= p.MinimumQuantity).ToList();
                }
            }
            catch (TauriValidationException ex)
            {
                NotificationService.ShowError($"Inventory Error: {ex.Message}");
                lowStockProducts = new List<Product>();
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to check stock: {ex.Message}");
                lowStockProducts = new List<Product>();
            }

            // Calculate turnover
            // Turnover = Cost of Goods Sold / Average Inventory
            // We'll approximate using Revenue and Inventory Value
            try 
            {
                var summary = await ReportService.GetReportSummaryAsync();
                if (summary != null && summary.InventoryValue > 0)
                {
                    inventoryTurnover = (double)summary.TotalRevenue / (double)summary.InventoryValue;
                }
                else
                {
                    inventoryTurnover = 0;
                }
            }
            catch (TauriValidationException ex)
            {
                 // Non-critical, but good to know
                 NotificationService.ShowError($"Turnover calc error: {ex.Message}");
                 inventoryTurnover = 0;
            }
            catch
            {
                // Non-critical
                inventoryTurnover = 0;
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Critical Dashboard Error: {ex.Message}");
            // Ensure non-nulls to prevent crash
            if (stats == null) stats = new DashboardStats();
            if (cashflow == null) cashflow = new List<ChartDataPoint>();
        }
    }

    private void ToggleEditMode()
    {
        editMode = !editMode;
    }

    private bool ShowWidget(string id) => !hiddenWidgets.Contains(id);

    private void ToggleWidget(string id)
    {
        if (hiddenWidgets.Contains(id))
            hiddenWidgets.Remove(id);
        else
            hiddenWidgets.Add(id);
    }
}
