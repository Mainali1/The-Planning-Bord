@page "/"
@inject IReportService ReportService
@inject IInventoryService InventoryService
@inject ITaskService TaskService
@inject IJSRuntime JS
@using ThePlanningBord.Models

<PageTitle>Dashboard - The Planning Bord</PageTitle>

<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
    <div class="flex space-x-2">
        <button @onclick="ToggleEditMode" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded inline-flex items-center">
            <span>@(editMode ? "Done" : "Customize Layout")</span>
        </button>
        <a href="reports" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
            <span>View Reports</span>
        </a>
    </div>
</div>

<div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-4">
    @if (ShowWidget("products")) {
    <div class="w-full px-4 py-5 bg-white rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 truncate">Total Products</div>
        <div class="mt-1 text-3xl font-semibold text-gray-900">@stats.TotalProducts</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("products")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
    @if (ShowWidget("lowstock")) {
    <div class="w-full px-4 py-5 bg-white rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 truncate">Low Stock Items</div>
        <div class="mt-1 text-3xl font-semibold text-red-600">@stats.LowStockItems</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("lowstock")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
    @if (ShowWidget("employees")) {
    <div class="w-full px-4 py-5 bg-white rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 truncate">Active Employees</div>
        <div class="mt-1 text-3xl font-semibold text-gray-900">@stats.TotalEmployees</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("employees")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
    @if (ShowWidget("revenue")) {
    <div class="w-full px-4 py-5 bg-white rounded-lg shadow relative group">
        <div class="text-sm font-medium text-gray-500 truncate">Est. Revenue (Mock)</div>
        <div class="mt-1 text-3xl font-semibold text-green-600">@stats.TotalRevenue.ToString("C")</div>
        @if(editMode) { <button @onclick='() => ToggleWidget("revenue")' class="absolute top-2 right-2 text-red-500">Hide</button> }
    </div>
    }
</div>

@if (editMode)
{
    <div class="mb-6 p-4 bg-gray-100 rounded border border-gray-300">
        <h3 class="font-bold mb-2">Hidden Widgets</h3>
        <div class="flex space-x-2">
            @foreach(var w in hiddenWidgets)
            {
                <button @onclick="() => ToggleWidget(w)" class="bg-white border border-gray-300 px-3 py-1 rounded text-sm hover:bg-gray-50">Show @w</button>
            }
        </div>
    </div>
}

@if (lowStockProducts.Any())
{
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 shadow rounded-md">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                    Low Stock Alerts (@lowStockProducts.Count)
                </h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc pl-5 space-y-1">
                        @foreach (var p in lowStockProducts)
                        {
                            <li>
                                <strong>@p.Name</strong> (SKU: @p.Sku) - Only @p.CurrentQuantity left (Min: @p.MinimumQuantity)
                                <a href="inventory" class="font-bold underline ml-2">Restock</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 gap-4">
            <a href="inventory" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                ðŸ“¦ Manage Inventory
            </a>
            <a href="tasks" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                âœ… View Tasks
            </a>
            <a href="employees" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                ðŸ‘¥ Employees
            </a>
            <a href="finance" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
                ðŸ’° Finance
            </a>
        </div>
    </div>

    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Cashflow Trend</h3>
        <div class="h-48 flex items-end space-x-2">
             @if (cashflow != null && cashflow.Any())
            {
                var maxVal = cashflow.Max(c => c.Value);
                if (maxVal == 0) maxVal = 1; 
                
                foreach (var point in cashflow)
                {
                    var height = (point.Value / maxVal) * 100;
                    <div class="flex-1 flex flex-col items-center group relative">
                        <div class="w-full bg-green-500 rounded-t hover:bg-green-600 transition-all duration-300" style="height: @height%"></div>
                        <div class="text-xs text-gray-500 mt-1 transform -rotate-45 origin-top-left">@point.Label</div>
                         <div class="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 z-10 whitespace-nowrap">
                            @point.Value.ToString("C")
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="w-full h-full flex items-center justify-center text-gray-400">No Data Available</div>
            }
        </div>
    </div>
</div>

@code {
    private DashboardStats stats = new();
    private List<Product> lowStockProducts = new();
    private List<ChartDataPoint> cashflow = new();
    
    private bool editMode = false;
    private HashSet<string> hiddenWidgets = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            stats = await ReportService.GetDashboardStatsAsync();
            cashflow = await ReportService.GetMonthlyCashflowAsync();
            
            // Get low stock for alert
            var productResult = await InventoryService.GetProductsAsync(null, 1, 1000);
            lowStockProducts = productResult.Items.Where(p => p.CurrentQuantity <= p.MinimumQuantity).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
    }

    private void ToggleEditMode()
    {
        editMode = !editMode;
    }

    private bool ShowWidget(string id) => !hiddenWidgets.Contains(id);

    private void ToggleWidget(string id)
    {
        if (hiddenWidgets.Contains(id))
            hiddenWidgets.Remove(id);
        else
            hiddenWidgets.Add(id);
    }
}
