@page "/suppliers"
@attribute [Authorize(Roles = "CEO,Manager,Inventory")]
@inject IInventoryService InventoryService
@inject NotificationService NotificationService
@inject MicrosoftGraphService GraphService
@inject IJSRuntime JS
@using ThePlanningBord.Models
@using System.Text.RegularExpressions
@using System.Text.Json

<PageTitle>Suppliers - The Planning Bord</PageTitle>

<div class="flex flex-col h-full relative">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Supplier Management</h3>
        <div class="flex space-x-4">
             <button @onclick="OpenAddSupplierModal" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                ➕ Add Supplier
            </button>
             <button @onclick="OpenAddOrderModal" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                ➕ Add Order
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button @onclick='() => SwitchTab("list")' class="@(activeTab == "list" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Supplier List
            </button>
            <button @onclick='() => SwitchTab("orders")' class="@(activeTab == "orders" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Orders
            </button>
        </nav>
    </div>

    <div class="flex-1 overflow-auto bg-white shadow rounded-lg">
        @if (activeTab == "list")
        {
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @if (isLoading) { <tr><td colspan="6" class="px-6 py-4 text-center">Loading...</td></tr> }
                    else if (!suppliers.Any()) 
                    { 
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center">
                                <div class="flex flex-col items-center justify-center space-y-2">
                                    <p class="text-gray-500">No suppliers found.</p>
                                    <button @onclick="OpenAddSupplierModal" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Add New Supplier
                                    </button>
                                </div>
                            </td>
                        </tr> 
                    }
                    else
                    {
                        @foreach (var s in suppliers)
                        {
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">@s.Name</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@s.ContactPerson</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@s.Phone</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@s.Email</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @(s.IsActive ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">
                                        @(s.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button @onclick="() => EditSupplier(s)" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                    <button @onclick="() => DeleteSupplier(s)" class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
        else
        {
             <div class="flex flex-col space-y-4">
                <div class="flex justify-end">
                    <button @onclick="OpenAddOrderModal" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                        ➕ Add Order
                    </button>
                </div>
                
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                            <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @if (orders == null || !orders.Any()) { <tr><td colspan="6" class="px-6 py-4 text-center">No orders found.</td></tr> }
                        else
                        {
                            @foreach (var o in orders)
                            {
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@o.OrderDate</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        @(suppliers.FirstOrDefault(s => s.Id == o.SupplierId)?.Name ?? "Unknown")
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@o.TotalAmount.ToString("C")</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @(o.Status == "completed" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800")">
                                            @o.Status
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs">@o.Notes</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @onclick="() => EditOrder(o)" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                        <button @onclick="() => DeleteOrder(o)" class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@if (showModal)
{
    <div class="fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true" @onclick="CloseModal">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">@((editingSupplier.Id.HasValue ? "Edit" : "Add")) Supplier</h3>
                    <div class="mt-4 grid grid-cols-1 gap-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name *</label>
                            <input type="text" @bind="editingSupplier.Name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" @bind="editingSupplier.Email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Order Email (for Auto-Orders)</label>
                            <input type="email" @bind="editingSupplier.OrderEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g. orders@supplier.com" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" @bind="editingSupplier.Phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea @bind="editingSupplier.Address" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" @bind="editingSupplier.IsActive" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                            <label class="ml-2 block text-sm text-gray-900">Active</label>
                        </div>

                        <!-- Product Assignment -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Assigned Products</h4>
                            <div class="max-h-40 overflow-y-auto border border-gray-200 rounded-md p-2">
                                @if (products == null || !products.Any())
                                {
                                    <p class="text-xs text-gray-500">No products found.</p>
                                }
                                else
                                {
                                    @foreach (var p in products)
                                    {
                                        <div class="flex items-center mb-1">
                                            <input type="checkbox" 
                                                   checked="@selectedProductIds.Contains(p.Id ?? 0)"
                                                   @onchange="@(e => ToggleProductSelection(p.Id ?? 0, e.Value))"
                                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                            <label class="ml-2 block text-sm text-gray-700">
                                                @p.Name <span class="text-xs text-gray-500">(@(string.IsNullOrEmpty(p.SupplierName) ? "Unassigned" : p.SupplierName))</span>
                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @onclick="SaveSupplier" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                    <button type="button" @onclick="CloseModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showOrderModal)
{
    <div class="fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true" @onclick="CloseOrderModal">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">@((editingOrder.Id.HasValue ? "Edit" : "Add")) Supplier Order</h3>
                    <div class="mt-4 grid grid-cols-1 gap-y-4">
                        <!-- Supplier Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Supplier *</label>
                            <select @bind="editingOrder.SupplierId" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="0">-- Select Supplier --</option>
                                @foreach (var s in suppliers.Where(x => x.IsActive))
                                {
                                    <option value="@s.Id">@s.Name</option>
                                }
                            </select>
                        </div>
                        
                        <!-- Items Section -->
                        <div class="border-t border-b border-gray-200 py-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Order Items</h4>
                            <div class="flex space-x-2 mb-2">
                                <select @bind="newOrderItem.ProductId" class="block w-full border-gray-300 rounded-md shadow-sm text-sm">
                                    <option value="0">Select Product...</option>
                                    @if (products != null)
                                    {
                                        @foreach (var p in products)
                                        {
                                            <option value="@p.Id">@p.Name (@p.CurrentQuantity in stock)</option>
                                        }
                                    }
                                </select>
                                <input type="number" @bind="newOrderItem.Quantity" placeholder="Qty" class="block w-20 border-gray-300 rounded-md shadow-sm text-sm" />
                                <button type="button" @onclick="AddItem" class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm">Add</button>
                            </div>
                            
                            @if (currentOrderItems.Any())
                            {
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500">Product</th>
                                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500">Qty</th>
                                            <th class="px-2 py-1 text-right text-xs font-medium text-gray-500">Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in currentOrderItems)
                                        {
                                            <tr>
                                                <td class="px-2 py-1 text-sm">@item.ProductName</td>
                                                <td class="px-2 py-1 text-sm">@item.Quantity</td>
                                                <td class="px-2 py-1 text-sm text-right">@item.TotalPrice.ToString("C")</td>
                                                <td class="px-2 py-1 text-right">
                                                    <button type="button" @onclick="() => RemoveItem(item)" class="text-red-600 hover:text-red-900 text-xs">Remove</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total Amount</label>
                            <input type="number" step="0.01" @bind="editingOrder.TotalAmount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <select @bind="editingOrder.Status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="pending">Pending</option>
                                <option value="sent">Sent</option>
                                <option value="received">Received</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea @bind="editingOrder.Notes" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @onclick="SaveOrder" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                    @if (editingOrder.Id.HasValue && editingOrder.Status != "received" && editingOrder.Status != "cancelled")
                    {
                        <button type="button" @onclick="ReceiveOrder" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 sm:ml-3 sm:w-auto sm:text-sm">Receive Inventory</button>
                    }
                    <button type="button" @onclick="CloseOrderModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "list";
    private bool isLoading = false;
    private List<Supplier> suppliers = new();
    private bool showModal = false;
    private Supplier editingSupplier = new();
    
    // Order variables
    private List<SupplierOrder> orders = new();
    private bool showOrderModal = false;
    private SupplierOrder editingOrder = new();
    
    private List<Product> products = new();
    private List<OrderItem> currentOrderItems = new();
    private OrderItem newOrderItem = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSuppliers();
        await LoadOrders();
        await LoadProducts();
    }

    private async Task LoadSuppliers()
    {
        isLoading = true;
        try
        {
            suppliers = await InventoryService.GetSuppliersAsync();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load suppliers: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        try
        {
            orders = await InventoryService.GetSupplierOrdersAsync();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load orders: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadProducts()
    {
        try
        {
            var pagedResult = await InventoryService.GetProductsAsync();
            products = pagedResult?.Items ?? new List<Product>();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
            products = new List<Product>();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to load products: " + ex.Message);
            products = new List<Product>();
        }
    }

    private void AddItem()
    {
        if (newOrderItem.ProductId == 0) return;
        if (newOrderItem.Quantity <= 0) return;
        
        var product = products.FirstOrDefault(p => p.Id == newOrderItem.ProductId);
        if (product == null) return;
        
        newOrderItem.ProductName = product.Name;
        newOrderItem.UnitPrice = product.UnitPrice;
        
        currentOrderItems.Add(newOrderItem);
        
        // Recalculate total
        editingOrder.TotalAmount = currentOrderItems.Sum(i => i.TotalPrice);
        
        newOrderItem = new();
    }
    
    private void RemoveItem(OrderItem item)
    {
        currentOrderItems.Remove(item);
        editingOrder.TotalAmount = currentOrderItems.Sum(i => i.TotalPrice);
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
    }

    // --- Supplier Management Methods ---

    private string originalSupplierName = "";
    private HashSet<int> selectedProductIds = new();

    private void OpenAddSupplierModal()
    {
        editingSupplier = new Supplier { IsActive = true };
        originalSupplierName = "";
        selectedProductIds.Clear();
        showModal = true;
    }

    private void EditSupplier(Supplier supplier)
    {
        editingSupplier = new Supplier
        {
            Id = supplier.Id,
            Name = supplier.Name,
            ContactPerson = supplier.ContactPerson,
            Phone = supplier.Phone,
            Email = supplier.Email,
            Address = supplier.Address,
            IsActive = supplier.IsActive
        };
        originalSupplierName = supplier.Name;
        
        // Pre-select products assigned to this supplier
        selectedProductIds = products
            .Where(p => p.SupplierName == supplier.Name && p.Id.HasValue)
            .Select(p => p.Id.GetValueOrDefault())
            .ToHashSet();
            
        showModal = true;
    }

    private void ToggleProductSelection(int productId, object? checkedValue)
    {
        if (checkedValue is bool isChecked && isChecked)
        {
            selectedProductIds.Add(productId);
        }
        else
        {
            selectedProductIds.Remove(productId);
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveSupplier()
    {
        if (string.IsNullOrWhiteSpace(editingSupplier.Name))
        {
            NotificationService.ShowError("Supplier Name is required.");
            return;
        }

        // Validate Phone OR Email
        if (string.IsNullOrWhiteSpace(editingSupplier.Phone) && string.IsNullOrWhiteSpace(editingSupplier.Email))
        {
            NotificationService.ShowError("Either Phone or Email is required.");
            return;
        }

        // Cleanup empty strings to null to avoid DB constraints or empty values
        if (string.IsNullOrWhiteSpace(editingSupplier.Phone)) editingSupplier.Phone = null;
        if (string.IsNullOrWhiteSpace(editingSupplier.Email)) editingSupplier.Email = null;
        if (string.IsNullOrWhiteSpace(editingSupplier.ContactPerson)) editingSupplier.ContactPerson = null;
        if (string.IsNullOrWhiteSpace(editingSupplier.Address)) editingSupplier.Address = null;

        try
        {
            if (editingSupplier.Id.HasValue)
            {
                await InventoryService.UpdateSupplierAsync(editingSupplier);
                
                // Handle product assignments and name changes
                bool nameChanged = !string.Equals(originalSupplierName, editingSupplier.Name, StringComparison.OrdinalIgnoreCase);
                
                // 1. If name changed, migrate all old products first
                if (nameChanged && !string.IsNullOrEmpty(originalSupplierName))
                {
                    var productsToMigrate = products.Where(p => p.SupplierName == originalSupplierName).ToList();
                    foreach (var p in productsToMigrate)
                    {
                        p.SupplierName = editingSupplier.Name;
                        await InventoryService.UpdateProductAsync(p);
                    }
                }

                // 2. Update assignments based on selection
                foreach (var p in products)
                {
                    if (!p.Id.HasValue) continue;

                    bool isSelected = selectedProductIds.Contains(p.Id.Value);
                    bool currentlyAssignedToThis = p.SupplierName == editingSupplier.Name;

                    if (isSelected && !currentlyAssignedToThis)
                    {
                        // Assign to this supplier
                        p.SupplierName = editingSupplier.Name;
                        await InventoryService.UpdateProductAsync(p);
                    }
                    else if (!isSelected && currentlyAssignedToThis)
                    {
                        // Unassign
                        p.SupplierName = null;
                        await InventoryService.UpdateProductAsync(p);
                    }
                }

                NotificationService.ShowSuccess("Supplier and products updated.");
            }
            else
            {
                await InventoryService.AddSupplierAsync(editingSupplier);
                
                // Assign selected products to new supplier
                foreach (var pId in selectedProductIds)
                {
                    var p = products.FirstOrDefault(x => x.Id == pId);
                    if (p != null)
                    {
                        p.SupplierName = editingSupplier.Name;
                        await InventoryService.UpdateProductAsync(p);
                    }
                }
                
                NotificationService.ShowSuccess("Supplier added.");
            }
            showModal = false;
            await LoadSuppliers();
            await LoadProducts(); // Reload to reflect changes
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to save supplier: " + ex.Message);
        }
    }

    private async Task DeleteSupplier(Supplier supplier)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete supplier '{supplier.Name}'?"))
            return;

        try 
        {
            await InventoryService.DeleteSupplierAsync(supplier.Id ?? 0);
            NotificationService.ShowSuccess("Supplier deleted.");
            await LoadSuppliers();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to delete supplier: " + ex.Message);
        }
    }

    // --- Order Management Methods ---

    private void OpenAddOrderModal()
    {
        editingOrder = new SupplierOrder { Status = "pending" };
        currentOrderItems = new();
        newOrderItem = new();
        showOrderModal = true;
    }

    private void EditOrder(SupplierOrder order)
    {
        editingOrder = new SupplierOrder
        {
            Id = order.Id,
            SupplierId = order.SupplierId,
            TotalAmount = order.TotalAmount,
            Status = order.Status,
            Notes = order.Notes,
            ItemsJson = order.ItemsJson
        };
        
        if (!string.IsNullOrEmpty(order.ItemsJson))
        {
            try {
                currentOrderItems = JsonSerializer.Deserialize<List<OrderItem>>(order.ItemsJson) ?? new();
            } catch { currentOrderItems = new(); }
        }
        else 
        {
            currentOrderItems = new();
        }
        
        newOrderItem = new();
        showOrderModal = true;
    }

    private void CloseOrderModal()
    {
        showOrderModal = false;
    }

    private bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email)) return false;
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private async Task SaveOrder()
    {
        // Serialize items first
        if (currentOrderItems.Any())
        {
            editingOrder.ItemsJson = JsonSerializer.Serialize(currentOrderItems);
        }
        else
        {
            editingOrder.ItemsJson = null;
        }

        // Validation
        if (editingOrder.SupplierId <= 0)
        {
            NotificationService.ShowError("Supplier is required.");
            return;
        }

        if (editingOrder.TotalAmount <= 0)
        {
            NotificationService.ShowError("Total amount must be greater than zero.");
            return;
        }

        // Email validation for the order context if needed, but here we validate the supplier's email when sending
        
        try
        {
            if (editingOrder.Id.HasValue)
            {
                await InventoryService.UpdateSupplierOrderAsync(editingOrder);
                NotificationService.ShowSuccess("Order updated.");
            }
            else
            {
                await InventoryService.AddSupplierOrderAsync(editingOrder);
                NotificationService.ShowSuccess("Order created.");

                var supplier = suppliers.FirstOrDefault(s => s.Id == editingOrder.SupplierId);
                if (supplier != null && !string.IsNullOrEmpty(supplier.Email) && IsValidEmail(supplier.Email))
                {
                    var lines = new List<string>();
                    lines.Add($"Dear {(string.IsNullOrWhiteSpace(supplier.ContactPerson) ? supplier.Name : supplier.ContactPerson)},");
                    lines.Add("");
                    lines.Add("We would like to place the following order:");
                    lines.Add("");

                    if (currentOrderItems.Any())
                    {
                        lines.Add("Items:");
                        foreach (var item in currentOrderItems)
                        {
                            lines.Add($"- {item.ProductName} x {item.Quantity} @ {item.UnitPrice:C} = {item.TotalPrice:C}");
                        }
                        lines.Add("");
                        lines.Add($"Total order amount: {editingOrder.TotalAmount:C}");
                    }
                    else
                    {
                        lines.Add($"Total order amount: {editingOrder.TotalAmount:C}");
                    }

                    if (!string.IsNullOrWhiteSpace(editingOrder.Notes))
                    {
                        lines.Add("");
                        lines.Add("Notes from the team:");
                        lines.Add(editingOrder.Notes);
                    }

                    lines.Add("");
                    lines.Add("Please confirm receipt of this order and estimated delivery date.");
                    lines.Add("");
                    lines.Add("Best regards,");
                    lines.Add("The Planning Bord");

                    string subject = $"Purchase Order from The Planning Bord - {DateTime.Now:yyyy-MM-dd}";
                    string content = string.Join("\n", lines);
                    
                    try
                    {
                        await GraphService.SendRestockEmailAsync(supplier.Email, subject, content);
                        NotificationService.ShowInfo("Order email sent to supplier.");
                    }
                    catch (Exception emailEx)
                    {
                        NotificationService.ShowWarning("Order saved but failed to send email: " + emailEx.Message);
                    }
                }
            }
            showOrderModal = false;
            await LoadOrders();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to save order: " + ex.Message);
        }
    }

    private async Task ReceiveOrder()
    {
        if (!currentOrderItems.Any())
        {
            NotificationService.ShowError("No items to receive.");
            return;
        }

        try 
        {
            int successCount = 0;
            var supplier = suppliers.FirstOrDefault(s => s.Id == editingOrder.SupplierId);
            string supplierName = supplier?.Name ?? "Unknown Supplier";

            foreach (var item in currentOrderItems)
            {
                var batch = new InventoryBatch
                {
                    ProductId = item.ProductId,
                    BatchNumber = $"SUP-{editingOrder.Id}-{DateTime.Now:yyMMdd}-{item.ProductId}-{new Random().Next(100, 999)}",
                    Quantity = item.Quantity,
                    ManufacturingDate = DateTime.Now.ToShortDateString(), // Default to today
                    ExpirationDate = DateTime.Now.AddMonths(12).ToShortDateString(), // Default +1 year
                    ReceivedDate = DateTime.Now.ToShortDateString(),
                    SupplierInfo = $"Order #{editingOrder.Id} from {supplierName}",
                    SupplierId = editingOrder.SupplierId,
                    Status = "Active",
                    Notes = $"Auto-generated from Supplier Order #{editingOrder.Id}"
                };

                await InventoryService.AddBatchAsync(batch);
                successCount++;
            }

            editingOrder.Status = "received";
            await SaveOrder();
            NotificationService.ShowSuccess($"Received {successCount} items into inventory.");
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to receive inventory: " + ex.Message);
        }
    }

    private async Task DeleteOrder(SupplierOrder order)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this order?"))
            return;

        try 
        {
            await InventoryService.DeleteSupplierOrderAsync(order.Id ?? 0);
            NotificationService.ShowSuccess("Order deleted.");
            await LoadOrders();
        }
        catch (TauriValidationException ex)
        {
            NotificationService.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Failed to delete order: " + ex.Message);
        }
    }

    private bool IsValidPhone(string phone)
    {
         if (string.IsNullOrWhiteSpace(phone)) return false;
         return Regex.IsMatch(phone, @"^[\d\s\-\+\(\)]{7,20}$");
    }
}
